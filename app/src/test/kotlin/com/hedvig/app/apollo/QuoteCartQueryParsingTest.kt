@file:OptIn(ApolloExperimental::class)

package com.hedvig.app.apollo

import assertk.assertThat
import assertk.assertions.isNotNull
import com.adyen.checkout.components.model.PaymentMethodsApiResponse
import com.apollographql.apollo3.annotations.ApolloExperimental
import com.apollographql.apollo3.api.ApolloResponse
import com.apollographql.apollo3.mockserver.enqueue
import com.hedvig.android.apollo.graphql.QuoteCartQuery
import com.hedvig.android.apollo.graphql.type.Locale
import com.hedvig.android.apollo.graphql.type.buildAdyen
import com.hedvig.android.apollo.graphql.type.buildPaymentConnection
import com.hedvig.android.apollo.graphql.type.buildQuoteCart
import org.json.JSONObject
import org.junit.Test

@Suppress("LocalVariableName")
class QuoteCartQueryParsingTest {

  @Test
  fun `apollo parses an quote cart query with availablePaymentMethods being a map`() =
    runApolloTest { mockServer, apolloClient ->
      val responseForQuoteCartId_2cac79da_ab37_434b_b425_df73343eb895_minified = """
            |{"data":{"quoteCart":{"__typename":"QuoteCart","id":"2cac79da-ab37-434b-b425-df73343eb895","bundle":{"possibleVariations":[{"id":"b5749af1-cb7c-4140-a05c-1e3897e88a82","description":null,"tag":null,"bundle":{"__typename":"QuoteBundle","displayName":"Home","quotes":[{"dataCollectionId":null,"displayName":"Home","startDate":"2022-06-15","email":"stylianos+99823@hedvig.com","id":"b5749af1-cb7c-4140-a05c-1e3897e88a82","typeOfContract":"DK_HOME_CONTENT_RENT","insuranceType":"DANISH_HOME_CONTENT","currentInsurer":null,"detailsTable":{"__typename":"Table","title":"Home","sections":[{"title":"Details","rows":[{"title":"Street","subtitle":null,"value":"Gulebøjsveien 1"},{"title":"Postal code","subtitle":null,"value":"2100"},{"title":"Living area","subtitle":null,"value":"44 m2"},{"title":"Insured people","subtitle":null,"value":"You + 1"},{"title":"Type","subtitle":null,"value":"Rental"}]}]},"contractPerils":[{"__typename":"PerilV2","title":"Fire","description":"The insurance covers fire, explosion, short circuit and similar damage when this occurs e.g. due to fire, lightning strike or electrical surge.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/fire_dark_942da46f6f.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/fire_97796e0790.svg"}}},"covered":["Direct lightning strike on the building","Electrical surge","Explosion","Result of firefighting damage and loss of items during fire","Fire damage to bicycle","Sudden sooting from room heating systems"],"exceptions":["Singeing and melting","Damage to items intentionally exposed to fire or heat"],"info":""},{"__typename":"PerilV2","title":"Water damage","description":"In the event of water and liquid flowing out of building pipe systems, the home contents are covered for damage. They are also covered if drains overflow due to rainstorm or thaw, or storm damage to the building where there is water ingress, e.g. via the roof, that damages home contents.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/water_damage_dark_227105c1de.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/water_damage_e25b83cd0b.svg"}}},"covered":["Discharge of water, steam, oil, or coolant that occurs suddenly from installations, aquariums or other containers with a capacity of 20 liters or more","If the damage originates from hidden pipe installations","Storm damage to items inside the dwelling, in the event of damage to the building","Flooding from roof, ground or balcony due to severe rainstorm or sudden thaw","Damage caused by meltwater or precipitation if the damage occurs at the same time as a storm or other sudden damage to the building or covering material"],"exceptions":["Damage caused by frost burst in buildings or premises, unless the damage is caused by a temporary failure of the heat supply","Damage caused by frost burst in outdoor installations or from gutters and drainpipes","Damage caused by building and repair works","Storm damage to contents outside a building, e.g.. garden furniture"],"info":""},{"__typename":"PerilV2","title":"Burglary","description":"When someone, without your permission, accesses your dwelling and there are clear signs of a forced entry through doors, windows or anything else.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/burglary_dark_e79b95b4bc.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/burglary_946096433f.svg"}}},"covered":["Theft from a securely locked building, room or safety deposit box at a financial institution","Theft of or damage to bicycle","Any fees associated with services by private security and alarm companies, in protecting home and personal belongings"],"exceptions":["If the dwelling has been uninhabited for more than 6 months","If there is no clear evidence of forced entry with regard to the building, hotel room or apartment, holiday home, cabin, train compartment or safety deposit box at a financial institution"],"info":""},{"__typename":"PerilV2","title":"Theft, robbery, assault and vandalism","description":"You are covered if your items are stolen from you, including while abroad, outside your home or if stolen from the home if it has not been securely locked","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/theft_and_damage_dark1_e005395885.svg"},"light":{"svgUrl":"https://promise.hedvig.com/theft_and_damage1_f2d82bd53d.svg"}}},"covered":["Items that are outside a building or are stolen from an unlocked building or room","Theft from a car, tourist coach, mobile home, sea vessel or aircraft* and inhabited caravan and tent","Theft in which the thief uses violence or threats of violence against the insured person","Theft and other damage to items as a result of assault against insured persons","Theft of items while the insured person is nearby and if the theft is noticed by the insured person or by others at the moment when the thief took the item and there is an immediate cry for help, or others can witness the theft","Vandalism damage caused intentionally in and at the year-round residence of the insured persons","Theft of or damage to bicycle"],"exceptions":["Forgotten, lost or misplaced items","Theft or vandalism committed by insured persons, their assistants or lodgers","Theft from the dwelling when it is uninhabited for more than 6 months, lent or rented out","Theft from a car, tourist coach, caravan, mobile home, sea vessel or aircraft if there is no evidence of forced entry with regard to the exterior lock, door or window"],"info":""},{"__typename":"PerilV2","title":"Festivals","description":"Many of your items are covered with this additional insurance that is included by default in your policy. There is cover for items inside your tent, even if you have not put a padlock on it and you are not in the tent.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/festival_dark_83db7e14dc.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/festival_d9c412ac1a.svg"}}},"covered":["Applies only in Denmark and to theft","A maximum of DKK 15,000.00 can be covered, regardless of the size of the total claim","There is no requirement for a tent to be locked"],"exceptions":["Forgotten, lost or misplaced items.","Damage caused by the insured person, e.g., as the result of a fight","However, there is no coverage for jewellery/watches of any kind, regardless of value, nor for cash or other cash equivalents","No coverage for beer, wine and spirits left outside the tent","The insurance also excludes mobile phones and computers left in tents or at the campsite"],"info":""},{"__typename":"PerilV2","title":"Traffic accident","description":"If you or someone from your household is involved in a traffic accident, crash or collision, the insurance covers any property that is broken.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/traffic_accident_dark_ee1e40a677.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/traffic_accident_d1e50e888e.svg"}}},"covered":["Damage to insured items as a result of impact, collision or overturning involving a means of transport","Accidents involving a pleasure craft with covered berths if the insured person is a passenger. The vessel does not have to belong to one of the insured persons","Triggered and damaged Hövdinge (Airbag) bicycle helmets","Damage to bicycle"],"exceptions":["Removal goods or items that are transported for a fee","Damage to items that are dropped and subsequently run over"],"info":""},{"__typename":"PerilV2","title":"Electronics","description":"Malfunction of the appliance if mechanical or electrical fault means that you cannot use the appliance for its intended purpose.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/valuables_dark_7e4cb716ac.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/valuables_1e1336600f.svg"}}},"covered":["All electrical appliances and white goods","Damage to refrigerated and frozen goods","Short-circuit, induction, electrical surge or the like"],"exceptions":["Cosmetic damage including scratches, scrapes and soiling","Damage covered by warranty or service schemes","Damage caused by overload, misuse, incorrect assembly or connection","An incorrectly performed repair or damage caused during repair","Loss of software or data including digital images and music files. Damage caused by virus attacks or errors in software or data. Costs of adjustments or troubleshooting where there are no faults in the device","Damage caused by household pets","Loose parts of appliances that are not a fixed part of the appliance, including extra photo lenses, cables, bags, batteries, light bulbs, memory cards and ink cartridges","Used appliances that were damaged at the time of purchase"],"info":""},{"__typename":"PerilV2","title":"Sudden damage","description":"There is cover for damage that occurs unexpectedly and suddenly at one time, e.g., if you stumble and let go of your mobile phone, it falls to the ground and the screen smashes","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/all_risk_dark_c6f43f63a6.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/all_risk_eba77dfb03.svg"}}},"covered":["Damage where the incident occurs unexpectedly and suddenly at the same time"],"exceptions":["Damage that happens over a period of time and not suddenly. For example, there is no coverage for a kitchen appliance in use that moves across the worktop and falls to the floor.","Cosmetic damage including scratches, scrapes and soiling"],"info":""},{"__typename":"PerilV2","title":"Bicycles","description":"Bicycles and bicycle parts are covered, even if the part is not fitted","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/electric_bike_dark_0d3091dd70.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/electric_bike_77259a50ab.svg"}}},"covered":["Injuries and damage caused by traffic accidents and collisions","Fire damage","If a bicycle is stolen as a result of a break-in or robbery, and you can provide the frame number.","Theft of the bicycle from outside the building where the bicycle had a frame number, and you can present receipt of an insurance-approved lock"],"exceptions":["Storm damage to bicycles or bicycle parts when located outside the building is not covered","Cosmetic damage such as scratches and scrapes are not covered by the insurance"],"info":""},{"__typename":"PerilV2","title":"White goods","description":"If there is a short circuit or electronic fault in white goods, this is covered by the insurance.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/appliance_damage_dark_03df6c1df9.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/appliance_damage_2a23c61a09.svg"}}},"covered":["Damage caused by fire, short circuit and lightning/induction","Electronic malfunctions","Fire, singeing, melting or charring of laundry in washing machines or dryers are covered when the damage is caused by a mechanical or technical fault"],"exceptions":["Damaged clothes that have been washed or dried at too high a temperature is not covered","Cosmetic damage such as scratches and scrapes are not covered by the insurance","Damage caused by overload, misuse, incorrect assembly or connection"],"info":""},{"__typename":"PerilV2","title":"Luggage on holiday","description":"The insurance covers journeys to/from Denmark as well as abroad, the Faroe Islands and Greenland, for up to 3 months from the date of departure. This applies both to items taken on holiday and to anything acquired on the trip.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/luggage_dark_0e7bfe6492.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/luggage_5d7829e6b4.svg"}}},"covered":["Luggage that the insured person sends by air, rail or carrier is also covered for loss or damage, regardless of whether the destination is in Denmark or abroad","Luggage that the insured person takes with them andplaces in a special luggage compartment in a coach, is covered for loss during the journey itself when travelling to/from and while abroad, plus the Faroe Islands and Greenland"],"exceptions":["Damage caused by poor packaging or packed liquids escaping","Damage consisting of general damage to suitcases, bags and other luggage","Loss or expense of delayed luggage","Damage covered by another insurance policy"],"info":""},{"__typename":"PerilV2","title":"Psychological counselling","description":"The insurance covers psychological crisis counselling if you have been directly involved in an incident which has led to an acute mental crisis for you.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/psychological_support_dark_c504cec425.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/psychological_support_37ddfcc607.svg"}}},"covered":["A fire that has claimed human lives or where there has been an imminent danger to human life","You or someone in your household has been subjected to aggravated robbery, violence or assault"],"exceptions":["The insurance covers only the 2 types of incident mentioned","There is no help for expenses for seeing a psychotherapist"],"info":""},{"__typename":"PerilV2","title":"Legal expenses","description":"Covers the costs of cases that can reasonably resolve certain private legal disputes.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/legal_protection_dark_bc536f7368.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/legal_protection_f6e65e1b13.svg"}}},"covered":["You must be involved in the case as a private individual","A court must be able to decide your case"],"exceptions":["The dispute must not be related to your profession","A company cannot use this insurance to recover its legal costs","If an approved board of appeal, e.g., the Consumer Complaints Board, can hear the case, you are obliged to make use of this option first"],"info":""},{"__typename":"PerilV2","title":"Personal liability","description":"The insurance pays compensation for damage and injury to persons, property and animals which the insured persons as private individuals, according to current case law, are held responsible for.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/liability_dark_164eb67626.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/liability_c331907aff.svg"}}},"covered":["In some cases, damage caused by children under 5 years of age may be covered","Guest damage, in other words damage to property that occurs during an ordinary private gathering. A private gathering can be both within the home or elsewhere outside the home. There are no special rules or exceptions around invitations"],"exceptions":["Liability based solely on the wording of a contract, lease agreement or other contractual basis","Liability for damage to property or animals owned by the insured persons","Liability for damage that occurs in connection with your profession or work for others","Liability for damage caused by the use of garden and work tools with motors","Liability for damage caused by dogs","Liability for damage that occurs during hunting or in direct connection with hunting","Liability for damage caused by the use of aircraft, including radio-controlled model aircraft/drones","Liability for damage that occurs as a result of self-inflicted intoxication, self-inflicted influence of drugs, toxins or other intoxicants. This applies regardless of the state of mind of the person responsible for the damage"],"info":""}],"insurableLimits":[{"__typename":"InsurableLimit","label":"Max insurable sum","limit":"DKK 1,000,000","description":"All your possessions are together insured up to 1 million DKK."},{"__typename":"InsurableLimit","label":"Deductible","limit":"DKK 500","description":"Deductible is the amount you have to pay yourself in the event of a damage. For claims the deductible is 500 DKK."},{"__typename":"InsurableLimit","label":"Bike, max","limit":"DKK 10,000","description":"You will be compensated for the value of the bike and parts up to 10 000 DKK minus the deductible of 500 DKK."},{"__typename":"InsurableLimit","label":"Luggage, max","limit":"DKK 30,000","description":"Luggage you bring with you on a trip are together insured up to 30 000 DKK."}],"insuranceTerms":[{"__typename":"InsuranceTerm","type":"TERMS_AND_CONDITIONS","displayName":"Insurance Terms Home Contents","url":"https://promise.hedvig.com/Terms_Home_Contents_V1_0_ed5623acc8.pdf"},{"__typename":"InsuranceTerm","type":"PRE_SALE_INFO_EU_STANDARD","displayName":"EU standard pre-sale information","url":"https://cdn.hedvig.com/info/dk/Indbo_IPID.pdf"}]}],"bundleCost":{"__typename":"InsuranceCost","monthlyDiscount":{"__typename":"MonetaryAmountV2","amount":"0.00","currency":"DKK"},"monthlyNet":{"__typename":"MonetaryAmountV2","amount":"149.00","currency":"DKK"},"monthlyGross":{"__typename":"MonetaryAmountV2","amount":"149.00","currency":"DKK"}},"frequentlyAskedQuestions":[{"id":"ckocnud5s7sev0e03dgg2t6y2","headline":"What insurances does Hedvig offer?","body":"Hedvig insures apartments, student housing, and condos – whether or not you own it, rent it, or just lets a room. We currently offer Home Contents Insurance, as well as two insurance bundles, Home & Accident insurance bundle, and Home, Accident & Travel insurance bundle. If you want the #01 next generation insurance provider and need multiple types of protection, Hedvig is your choice. Our insurance experts have put together all the coverage you need, hopefully at a better price."},{"id":"ckocnw9u0lnqa0c06rn99h3s9","headline":"How does Hedvig differ from other insurance companies?","body":"The most significant difference between Hedvig and the rest is that we have eliminated the temptation of holding on to your money instead of paying it back out. 75% of your premium goes to covering our members' claims. The remaining 25% goes to improving our insurance and making the experience effortless. At the end of the year, the money that is left is donated to WeShelter – an organization working to aid homelessness in Denmark."},{"id":"ckocnzbeg0ybk0b03db9xpmni","headline":"Where can I find more coverage details?","body":"You can view the Hedvig policy on our terms & conditions page. You can also get a quote and view the policy together with your price. Once you become a member, you’ll be able to check your policy and get instant help in the Hedvig app. "},{"id":"ckoco04q00z9s0b03xt5tmddy","headline":"Can I cancel Hedvig at anytime?","body":"Absolutely, your insurance can be cancelled at anytime. You can email or chat with us in the Hedvig app to tell us what date you want to cancel your insurance. When canceling your insurance, at the middle of the month, we only charge for the days up until the cancellation date, eg: you cancel Hedvig the 15th, then we charge the first 15 days on the 27th the same month."},{"id":"ckoco3a5clupq0c06wsh3r66d","headline":"How do I get Hedvig for free?","body":"Tell others about Hedvig and lower your premium. When someone signs up with Hedvig with your link or code, you both receive a 10 DKK discount on your monthly payment. This means that if you invite enough friends, you can get free home insurance for life. Find out more"}],"inception":{"__typename":"ConcurrentInception","correspondingQuoteIds":["b5749af1-cb7c-4140-a05c-1e3897e88a82"],"startDate":"2022-06-15","currentInsurer":null},"appConfiguration":{"showCampaignManagement":true,"showFAQ":true,"ignoreCampaigns":false,"approveButtonTerminology":"CONFIRM_PURCHASE","startDateTerminology":"START_DATE","title":"LOGO","gradientOption":"GRADIENT_THREE","postSignStep":"CONNECT_PAYIN"}}}]},"checkoutMethods":["SIMPLE_SIGN"],"checkout":null,"paymentConnection":{"id":null,"providers":[{"__typename":"Adyen",
            |"availablePaymentMethods":
            |{
                |"paymentMethods":[
                    |{
                        |"brands":["visadankort","mc","visa"],
                        |"details":[
                            |{"key":"encryptedCardNumber","type":"cardToken"},
                            |{"key":"encryptedSecurityCode","type":"cardToken"},
                            |{"key":"encryptedExpiryMonth","type":"cardToken"},
                            |{"key":"encryptedExpiryYear","type":"cardToken"},
                            |{"key":"holderName","optional":true,"type":"text"}
                        |],
                        |"name":"Credit Card",
                        |"type":"scheme"
                    |},
                    |{
                        |"configuration":{"merchantId":"50","gatewayMerchantId":"HEDVIG-DK"},
                        |"details":[
                            |{"key":"paywithgoogle.token","type":"payWithGoogleToken"}
                        |],
                        |"name":"Google Pay",
                        |"type":"paywithgoogle"
                    |}
                |]
            |}
            |}]}, "campaign":null}}}
      """.trimMargin()
      mockServer.enqueue(responseForQuoteCartId_2cac79da_ab37_434b_b425_df73343eb895_minified)

      val response = apolloClient
        .query(QuoteCartQuery(Locale.sv_SE, ""))
        .execute()

      assertThat(response.data).isNotNull()
      val paymentMethodsApiResponse: PaymentMethodsApiResponse? = response.availablePaymentMethods
      assertThat(paymentMethodsApiResponse).isNotNull()
    }

  @Test
  fun `apollo parses an quote cart query with availablePaymentMethods being a map 2`() =
    runApolloTest { mockServer, apolloClient ->
      val responseForQuoteCartId_2cac79da_ab37_434b_b425_df73343eb895_edited = """
                |{"data":{"quoteCart":{"__typename":"QuoteCart","id":"2cac79da-ab37-434b-b425-df73343eb895","bundle":{"possibleVariations":[{"id":"b5749af1-cb7c-4140-a05c-1e3897e88a82","description":null,"tag":null,"bundle":{"__typename":"QuoteBundle","displayName":"Home","quotes":[{"dataCollectionId":null,"displayName":"Home","startDate":"2022-06-15","email":"stylianos+99823@hedvig.com","id":"b5749af1-cb7c-4140-a05c-1e3897e88a82","typeOfContract":"DK_HOME_CONTENT_RENT","insuranceType":"DANISH_HOME_CONTENT","currentInsurer":null,"detailsTable":{"__typename":"Table","title":"Home","sections":[{"title":"Details","rows":[{"title":"Street","subtitle":null,"value":"Gulebøjsveien 1"},{"title":"Postal code","subtitle":null,"value":"2100"},{"title":"Living area","subtitle":null,"value":"44 m2"},{"title":"Insured people","subtitle":null,"value":"You + 1"},{"title":"Type","subtitle":null,"value":"Rental"}]}]},"contractPerils":[{"__typename":"PerilV2","title":"Fire","description":"The insurance covers fire, explosion, short circuit and similar damage when this occurs e.g. due to fire, lightning strike or electrical surge.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/fire_dark_942da46f6f.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/fire_97796e0790.svg"}}},"covered":["Direct lightning strike on the building","Electrical surge","Explosion","Result of firefighting damage and loss of items during fire","Fire damage to bicycle","Sudden sooting from room heating systems"],"exceptions":["Singeing and melting","Damage to items intentionally exposed to fire or heat"],"info":""},{"__typename":"PerilV2","title":"Water damage","description":"In the event of water and liquid flowing out of building pipe systems, the home contents are covered for damage. They are also covered if drains overflow due to rainstorm or thaw, or storm damage to the building where there is water ingress, e.g. via the roof, that damages home contents.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/water_damage_dark_227105c1de.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/water_damage_e25b83cd0b.svg"}}},"covered":["Discharge of water, steam, oil, or coolant that occurs suddenly from installations, aquariums or other containers with a capacity of 20 liters or more","If the damage originates from hidden pipe installations","Storm damage to items inside the dwelling, in the event of damage to the building","Flooding from roof, ground or balcony due to severe rainstorm or sudden thaw","Damage caused by meltwater or precipitation if the damage occurs at the same time as a storm or other sudden damage to the building or covering material"],"exceptions":["Damage caused by frost burst in buildings or premises, unless the damage is caused by a temporary failure of the heat supply","Damage caused by frost burst in outdoor installations or from gutters and drainpipes","Damage caused by building and repair works","Storm damage to contents outside a building, e.g.. garden furniture"],"info":""},{"__typename":"PerilV2","title":"Burglary","description":"When someone, without your permission, accesses your dwelling and there are clear signs of a forced entry through doors, windows or anything else.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/burglary_dark_e79b95b4bc.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/burglary_946096433f.svg"}}},"covered":["Theft from a securely locked building, room or safety deposit box at a financial institution","Theft of or damage to bicycle","Any fees associated with services by private security and alarm companies, in protecting home and personal belongings"],"exceptions":["If the dwelling has been uninhabited for more than 6 months","If there is no clear evidence of forced entry with regard to the building, hotel room or apartment, holiday home, cabin, train compartment or safety deposit box at a financial institution"],"info":""},{"__typename":"PerilV2","title":"Theft, robbery, assault and vandalism","description":"You are covered if your items are stolen from you, including while abroad, outside your home or if stolen from the home if it has not been securely locked","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/theft_and_damage_dark1_e005395885.svg"},"light":{"svgUrl":"https://promise.hedvig.com/theft_and_damage1_f2d82bd53d.svg"}}},"covered":["Items that are outside a building or are stolen from an unlocked building or room","Theft from a car, tourist coach, mobile home, sea vessel or aircraft* and inhabited caravan and tent","Theft in which the thief uses violence or threats of violence against the insured person","Theft and other damage to items as a result of assault against insured persons","Theft of items while the insured person is nearby and if the theft is noticed by the insured person or by others at the moment when the thief took the item and there is an immediate cry for help, or others can witness the theft","Vandalism damage caused intentionally in and at the year-round residence of the insured persons","Theft of or damage to bicycle"],"exceptions":["Forgotten, lost or misplaced items","Theft or vandalism committed by insured persons, their assistants or lodgers","Theft from the dwelling when it is uninhabited for more than 6 months, lent or rented out","Theft from a car, tourist coach, caravan, mobile home, sea vessel or aircraft if there is no evidence of forced entry with regard to the exterior lock, door or window"],"info":""},{"__typename":"PerilV2","title":"Festivals","description":"Many of your items are covered with this additional insurance that is included by default in your policy. There is cover for items inside your tent, even if you have not put a padlock on it and you are not in the tent.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/festival_dark_83db7e14dc.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/festival_d9c412ac1a.svg"}}},"covered":["Applies only in Denmark and to theft","A maximum of DKK 15,000.00 can be covered, regardless of the size of the total claim","There is no requirement for a tent to be locked"],"exceptions":["Forgotten, lost or misplaced items.","Damage caused by the insured person, e.g., as the result of a fight","However, there is no coverage for jewellery/watches of any kind, regardless of value, nor for cash or other cash equivalents","No coverage for beer, wine and spirits left outside the tent","The insurance also excludes mobile phones and computers left in tents or at the campsite"],"info":""},{"__typename":"PerilV2","title":"Traffic accident","description":"If you or someone from your household is involved in a traffic accident, crash or collision, the insurance covers any property that is broken.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/traffic_accident_dark_ee1e40a677.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/traffic_accident_d1e50e888e.svg"}}},"covered":["Damage to insured items as a result of impact, collision or overturning involving a means of transport","Accidents involving a pleasure craft with covered berths if the insured person is a passenger. The vessel does not have to belong to one of the insured persons","Triggered and damaged Hövdinge (Airbag) bicycle helmets","Damage to bicycle"],"exceptions":["Removal goods or items that are transported for a fee","Damage to items that are dropped and subsequently run over"],"info":""},{"__typename":"PerilV2","title":"Electronics","description":"Malfunction of the appliance if mechanical or electrical fault means that you cannot use the appliance for its intended purpose.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/valuables_dark_7e4cb716ac.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/valuables_1e1336600f.svg"}}},"covered":["All electrical appliances and white goods","Damage to refrigerated and frozen goods","Short-circuit, induction, electrical surge or the like"],"exceptions":["Cosmetic damage including scratches, scrapes and soiling","Damage covered by warranty or service schemes","Damage caused by overload, misuse, incorrect assembly or connection","An incorrectly performed repair or damage caused during repair","Loss of software or data including digital images and music files. Damage caused by virus attacks or errors in software or data. Costs of adjustments or troubleshooting where there are no faults in the device","Damage caused by household pets","Loose parts of appliances that are not a fixed part of the appliance, including extra photo lenses, cables, bags, batteries, light bulbs, memory cards and ink cartridges","Used appliances that were damaged at the time of purchase"],"info":""},{"__typename":"PerilV2","title":"Sudden damage","description":"There is cover for damage that occurs unexpectedly and suddenly at one time, e.g., if you stumble and let go of your mobile phone, it falls to the ground and the screen smashes","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/all_risk_dark_c6f43f63a6.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/all_risk_eba77dfb03.svg"}}},"covered":["Damage where the incident occurs unexpectedly and suddenly at the same time"],"exceptions":["Damage that happens over a period of time and not suddenly. For example, there is no coverage for a kitchen appliance in use that moves across the worktop and falls to the floor.","Cosmetic damage including scratches, scrapes and soiling"],"info":""},{"__typename":"PerilV2","title":"Bicycles","description":"Bicycles and bicycle parts are covered, even if the part is not fitted","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/electric_bike_dark_0d3091dd70.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/electric_bike_77259a50ab.svg"}}},"covered":["Injuries and damage caused by traffic accidents and collisions","Fire damage","If a bicycle is stolen as a result of a break-in or robbery, and you can provide the frame number.","Theft of the bicycle from outside the building where the bicycle had a frame number, and you can present receipt of an insurance-approved lock"],"exceptions":["Storm damage to bicycles or bicycle parts when located outside the building is not covered","Cosmetic damage such as scratches and scrapes are not covered by the insurance"],"info":""},{"__typename":"PerilV2","title":"White goods","description":"If there is a short circuit or electronic fault in white goods, this is covered by the insurance.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/appliance_damage_dark_03df6c1df9.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/appliance_damage_2a23c61a09.svg"}}},"covered":["Damage caused by fire, short circuit and lightning/induction","Electronic malfunctions","Fire, singeing, melting or charring of laundry in washing machines or dryers are covered when the damage is caused by a mechanical or technical fault"],"exceptions":["Damaged clothes that have been washed or dried at too high a temperature is not covered","Cosmetic damage such as scratches and scrapes are not covered by the insurance","Damage caused by overload, misuse, incorrect assembly or connection"],"info":""},{"__typename":"PerilV2","title":"Luggage on holiday","description":"The insurance covers journeys to/from Denmark as well as abroad, the Faroe Islands and Greenland, for up to 3 months from the date of departure. This applies both to items taken on holiday and to anything acquired on the trip.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/luggage_dark_0e7bfe6492.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/luggage_5d7829e6b4.svg"}}},"covered":["Luggage that the insured person sends by air, rail or carrier is also covered for loss or damage, regardless of whether the destination is in Denmark or abroad","Luggage that the insured person takes with them andplaces in a special luggage compartment in a coach, is covered for loss during the journey itself when travelling to/from and while abroad, plus the Faroe Islands and Greenland"],"exceptions":["Damage caused by poor packaging or packed liquids escaping","Damage consisting of general damage to suitcases, bags and other luggage","Loss or expense of delayed luggage","Damage covered by another insurance policy"],"info":""},{"__typename":"PerilV2","title":"Psychological counselling","description":"The insurance covers psychological crisis counselling if you have been directly involved in an incident which has led to an acute mental crisis for you.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/psychological_support_dark_c504cec425.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/psychological_support_37ddfcc607.svg"}}},"covered":["A fire that has claimed human lives or where there has been an imminent danger to human life","You or someone in your household has been subjected to aggravated robbery, violence or assault"],"exceptions":["The insurance covers only the 2 types of incident mentioned","There is no help for expenses for seeing a psychotherapist"],"info":""},{"__typename":"PerilV2","title":"Legal expenses","description":"Covers the costs of cases that can reasonably resolve certain private legal disputes.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/legal_protection_dark_bc536f7368.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/legal_protection_f6e65e1b13.svg"}}},"covered":["You must be involved in the case as a private individual","A court must be able to decide your case"],"exceptions":["The dispute must not be related to your profession","A company cannot use this insurance to recover its legal costs","If an approved board of appeal, e.g., the Consumer Complaints Board, can hear the case, you are obliged to make use of this option first"],"info":""},{"__typename":"PerilV2","title":"Personal liability","description":"The insurance pays compensation for damage and injury to persons, property and animals which the insured persons as private individuals, according to current case law, are held responsible for.","icon":{"variants":{"dark":{"svgUrl":"https://promise.hedvig.com/media/liability_dark_164eb67626.svg"},"light":{"svgUrl":"https://promise.hedvig.com/media/liability_c331907aff.svg"}}},"covered":["In some cases, damage caused by children under 5 years of age may be covered","Guest damage, in other words damage to property that occurs during an ordinary private gathering. A private gathering can be both within the home or elsewhere outside the home. There are no special rules or exceptions around invitations"],"exceptions":["Liability based solely on the wording of a contract, lease agreement or other contractual basis","Liability for damage to property or animals owned by the insured persons","Liability for damage that occurs in connection with your profession or work for others","Liability for damage caused by the use of garden and work tools with motors","Liability for damage caused by dogs","Liability for damage that occurs during hunting or in direct connection with hunting","Liability for damage caused by the use of aircraft, including radio-controlled model aircraft/drones","Liability for damage that occurs as a result of self-inflicted intoxication, self-inflicted influence of drugs, toxins or other intoxicants. This applies regardless of the state of mind of the person responsible for the damage"],"info":""}],"insurableLimits":[{"__typename":"InsurableLimit","label":"Max insurable sum","limit":"DKK 1,000,000","description":"All your possessions are together insured up to 1 million DKK."},{"__typename":"InsurableLimit","label":"Deductible","limit":"DKK 500","description":"Deductible is the amount you have to pay yourself in the event of a damage. For claims the deductible is 500 DKK."},{"__typename":"InsurableLimit","label":"Bike, max","limit":"DKK 10,000","description":"You will be compensated for the value of the bike and parts up to 10 000 DKK minus the deductible of 500 DKK."},{"__typename":"InsurableLimit","label":"Luggage, max","limit":"DKK 30,000","description":"Luggage you bring with you on a trip are together insured up to 30 000 DKK."}],"insuranceTerms":[{"__typename":"InsuranceTerm","type":"TERMS_AND_CONDITIONS","displayName":"Insurance Terms Home Contents","url":"https://promise.hedvig.com/Terms_Home_Contents_V1_0_ed5623acc8.pdf"},{"__typename":"InsuranceTerm","type":"PRE_SALE_INFO_EU_STANDARD","displayName":"EU standard pre-sale information","url":"https://cdn.hedvig.com/info/dk/Indbo_IPID.pdf"}]}],"bundleCost":{"__typename":"InsuranceCost","monthlyDiscount":{"__typename":"MonetaryAmountV2","amount":"0.00","currency":"DKK"},"monthlyNet":{"__typename":"MonetaryAmountV2","amount":"149.00","currency":"DKK"},"monthlyGross":{"__typename":"MonetaryAmountV2","amount":"149.00","currency":"DKK"}},"frequentlyAskedQuestions":[{"id":"ckocnud5s7sev0e03dgg2t6y2","headline":"What insurances does Hedvig offer?","body":"Hedvig insures apartments, student housing, and condos – whether or not you own it, rent it, or just lets a room. We currently offer Home Contents Insurance, as well as two insurance bundles, Home & Accident insurance bundle, and Home, Accident & Travel insurance bundle. If you want the #01 next generation insurance provider and need multiple types of protection, Hedvig is your choice. Our insurance experts have put together all the coverage you need, hopefully at a better price."},{"id":"ckocnw9u0lnqa0c06rn99h3s9","headline":"How does Hedvig differ from other insurance companies?","body":"The most significant difference between Hedvig and the rest is that we have eliminated the temptation of holding on to your money instead of paying it back out. 75% of your premium goes to covering our members' claims. The remaining 25% goes to improving our insurance and making the experience effortless. At the end of the year, the money that is left is donated to WeShelter – an organization working to aid homelessness in Denmark."},{"id":"ckocnzbeg0ybk0b03db9xpmni","headline":"Where can I find more coverage details?","body":"You can view the Hedvig policy on our terms & conditions page. You can also get a quote and view the policy together with your price. Once you become a member, you’ll be able to check your policy and get instant help in the Hedvig app. "},{"id":"ckoco04q00z9s0b03xt5tmddy","headline":"Can I cancel Hedvig at anytime?","body":"Absolutely, your insurance can be cancelled at anytime. You can email or chat with us in the Hedvig app to tell us what date you want to cancel your insurance. When canceling your insurance, at the middle of the month, we only charge for the days up until the cancellation date, eg: you cancel Hedvig the 15th, then we charge the first 15 days on the 27th the same month."},{"id":"ckoco3a5clupq0c06wsh3r66d","headline":"How do I get Hedvig for free?","body":"Tell others about Hedvig and lower your premium. When someone signs up with Hedvig with your link or code, you both receive a 10 DKK discount on your monthly payment. This means that if you invite enough friends, you can get free home insurance for life. Find out more"}],"inception":{"__typename":"ConcurrentInception","correspondingQuoteIds":["b5749af1-cb7c-4140-a05c-1e3897e88a82"],"startDate":"2022-06-15","currentInsurer":null},"appConfiguration":{"showCampaignManagement":true,"showFAQ":true,"ignoreCampaigns":false,"approveButtonTerminology":"CONFIRM_PURCHASE","startDateTerminology":"START_DATE","title":"LOGO","gradientOption":"GRADIENT_THREE","postSignStep":"CONNECT_PAYIN"}}}]},"checkoutMethods":["SIMPLE_SIGN"],"checkout":null,"paymentConnection":{"id":null,"providers":[{"__typename":"Adyen",
                |"availablePaymentMethods":
                |{
                    |"paymentMethods":[{"name":"Trustly","type":"trustly"}]
                |}
                |}]}, "campaign":null}}}
      """.trimMargin()
      mockServer.enqueue(responseForQuoteCartId_2cac79da_ab37_434b_b425_df73343eb895_edited)

      val response = apolloClient
        .query(QuoteCartQuery(Locale.sv_SE, ""))
        .execute()

      assertThat(response.data).isNotNull()
      val paymentMethodsApiResponse: PaymentMethodsApiResponse? = response.availablePaymentMethods
      assertThat(paymentMethodsApiResponse).isNotNull()
    }

  @Test
  fun `apollo parses an quote cart query with availablePaymentMethods being a string`() =
    runApolloTest { mockServer, apolloClient ->
      val jsonData = QuoteCartQuery.Data(TestFakeResolver) {
        quoteCart = buildQuoteCart {
          paymentConnection = buildPaymentConnection {
            providers = listOf(
              buildAdyen {
                availablePaymentMethods = PaymentMethodsApiResponse.SERIALIZER.deserialize(
                  JSONObject(
                    """
                    |{"paymentMethods":[{"brands":["visadankort","mc","visa"],"details":[{"key":"encryptedCardNumber","type":"cardToken"},{"key":"encryptedSecurityCode","type":"cardToken"},{"key":"encryptedExpiryMonth","type":"cardToken"},{"key":"encryptedExpiryYear","type":"cardToken"},{"key":"holderName","optional":true,"type":"text"}],"name":"Credit Card","type":"scheme"},{"configuration":{"merchantId":"50","gatewayMerchantId":"HEDVIG-DK"},"details":[{"key":"paywithgoogle.token","type":"payWithGoogleToken"}],"name":"Google Pay","type":"paywithgoogle"}]}
                    """.trimMargin(),
                  ),
                )
              },
            )
          }
        }
      }
      mockServer.enqueue(jsonData.toJsonStringWithData())

      val response = apolloClient
        .query(QuoteCartQuery(Locale.sv_SE, ""))
        .execute()

      assertThat(response.data).isNotNull()
      val paymentMethodsApiResponse: PaymentMethodsApiResponse? = response.availablePaymentMethods
      assertThat(paymentMethodsApiResponse).isNotNull()
    }
}

private val ApolloResponse<QuoteCartQuery.Data>.availablePaymentMethods
  get() = data?.quoteCart?.fragments?.quoteCartFragment?.paymentConnection?.providers?.firstOrNull()?.asAdyen
    ?.availablePaymentMethods
