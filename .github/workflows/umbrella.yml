name: Trigger new umbrella release

on:
  push:
    branches:
      - feature/kmp-publication
  workflow_dispatch:

concurrency:
  group: ref-${{ github.ref }}
  cancel-in-progress: true

jobs:
  umbrella_release:
    name: Build and release new umbrella version
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v4
#      - uses: gradle/actions/wrapper-validation@v4
#      - name: Copy CI gradle.properties
#        run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties
#      - uses: actions/setup-java@v4.7.1
#        with:
#          java-version: 21
#          distribution: 'zulu'
#      - name: Prebuild
#        run: ./scripts/ci-prebuild.sh
#        env:
#          HEDVIG_GITHUB_PACKAGES_USER: ${{ secrets.HEDVIG_GITHUB_PACKAGES_USER }}
#          HEDVIG_GITHUB_PACKAGES_TOKEN: ${{ secrets.HEDVIG_GITHUB_PACKAGES_TOKEN }}
#          DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
#          LOKALISE_ID: ${{ secrets.LOKALISE_ID }}
#          LOKALISE_TOKEN: ${{ secrets.LOKALISE_TOKEN }}
#      - name: Setup Gradle
#        uses: gradle/actions/setup-gradle@v4
#        with:
#          # Only write to the cache for builds on the 'develop' branch
#          cache-read-only: false
#      - run: echo VERSION_CODE=$(expr 1 + ${{ github.run_number }} + ${{ github.run_attempt }} - 1) >> $GITHUB_ENV
      - run: echo VERSION_CODE=0.0.4 >> $GITHUB_ENV

#      - name: Build
#        run: ./gradlew :umbrella:assembleUmbrellaReleaseXCFramework
      - name: Generate Package.swift file
        run: ./scripts/generate_package_swift.main.kts
        env:
          VERSION_CODE: ${{ env.VERSION_CODE }}